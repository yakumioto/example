---
version: '2'

services:

  orderer.akihiko.moe:
    image: hyperledger/fabric-orderer:1.4.0
    environment:
      - FABRIC_LOGGING_SPEC=DEBUG
      - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0
      - ORDERER_GENERAL_GENESISMETHOD=file
      - ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block
      - ORDERER_GENERAL_LOCALMSPID=Aincrad
      - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp
      - ORDERER_GENERAL_TLS_ENABLED=true
      - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_KAFKA_TOPIC_REPLICATIONFACTOR=1
      - ORDERER_KAFKA_VERBOSE=true
      - GODEBUG=netdns=go
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric
    command: orderer
    volumes:
      - ./channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block
      - fabric-sdk/swordartonline-network/crypto-config/ordererOrganizations/akihiko.moe/orderers/orderer.akihiko.moe/msp:/var/hyperledger/orderer/msp
      - fabric-sdk/swordartonline-network/crypto-config/ordererOrganizations/akihiko.moe/orderers/orderer.akihiko.moe/tls:/var/hyperledger/orderer/tls
    ports:
      - 7050:7050

  peer0.kirito.moe:
    image: hyperledger/fabric-peer:1.4.0
    environment:
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - FABRIC_LOGGING_SPEC=DEBUG
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_GOSSIP_USELEADERELECTION=true
      - CORE_PEER_GOSSIP_ORGLEADER=false
      - CORE_PEER_PROFILE_ENABLED=true
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      - CORE_PEER_ID=peer0.kirito.svc.cluster.local
      - CORE_PEER_ADDRESS=peer0.kirito.svc.cluster.local:7051
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.kirito.svc.cluster.local:7051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.kirito.svc.cluster.local:7051
      - CORE_PEER_LOCALMSPID=Kirito
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: peer node start
    volumes:
      - /var/run/:/host/var/run/
      - fabric-sdk/swordartonline-network/crypto-config/peerOrganizations/kirito.moe/peers/peer0.kirito.moe/msp:/etc/hyperledger/fabric/msp
      - fabric-sdk/swordartonline-network/crypto-config/peerOrganizations/kirito.moe/peers/peer0.kirito.moe/tls:/etc/hyperledger/fabric/tls
    ports:
      - 7051:7051
      - 7053:7053

  zk-svc.zookeeper.svc.cluster.local:
    image: hyperledger/fabric-zookeeper:0.4.14
    environment:
      ZOOKEEPER_CLIENT_PORT: 32181
      ZOOKEEPER_TICK_TIME: 2000

  kafka-svc.kafka.svc.cluster.local:
    image: hyperledger/fabric-kafka:0.4.14
    depends_on:
      - zk-svc.zookeeper.svc.cluster.local
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_ZOOKEEPER_CONNECT=zk-svc.zookeeper.svc.cluster.local:2181
      - KAFKA_LISTENERS=PLAINTEXT://:9092
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_MESSAGE_MAX_BYTES=1048576 # 1 * 1024 * 1024 B
      - KAFKA_REPLICA_FETCH_MAX_BYTES=1048576 # 1 * 1024 * 1024 B
      - KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE=false
      - KAFKA_LOG_RETENTION_MS=-1
      - KAFKA_MIN_INSYNC_REPLICAS=1
      - KAFKA_DEFAULT_REPLICATION_FACTOR=1